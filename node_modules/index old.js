var http = require('http');
var url = require('url');
var lodash = require('lodash');

var users = [{ id: '1', name: 'Illya Klymov', phone: '+380504020799', role: 'Administrator' },
  { id: '2', name: 'Ivanov Ivan', phone: '+380670000002', role: 'Student', strikes: 1 },
  { id: '3', name: 'Petrov Petr', phone: '+380670000001', role: 'Support', location: 'Kiev' }];

function setResponseHeaders(response) {
  response.setHeader('Content-Type', 'application/json');
  response.setHeader('Access-Control-Allow-Origin', '*');
}

var server = http.createServer(function (request, response) {
  var parsedUrl = url.parse(request.url, true);
  if(request.method === "OPTIONS") {
    response.writeHead(200, {
      'Access-Control-Allow-Methods': 'GET,HEAD,PUT,POST,DELETE',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'Content-Type',
      'Content-Type': 'application/json; charset=utf-8'
    });
    response.end();
  } else if(request.method === "GET") {
    response.writeHead(200, {
      'Access-Control-Allow-Methods': 'GET,HEAD,PUT,POST,DELETE, OPTIONS',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'Content-Type',
      'Content-Type': 'application/json; charset=utf-8'
    });
    response.end(JSON.stringify(users));
  }
  if (request.method === 'GET' && parsedUrl.pathname === '/refreshAdmins') {
    response.writeHead(200, {
      'Access-Control-Allow-Methods': 'GET,HEAD,PUT,POST,DELETE, OPTIONS',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'Content-Type',
      'Content-Type': 'application/json; charset=utf-8'
    });
    response.end(JSON.stringify(users));
  }
  if(request.method === "POST") {
    var body = '';
    request.on('data', function(resultdata) {
      body += resultdata;
      console.log(body);
    });
    request.on('end', function () {
      var parsed = JSON.parse(body);
      if (body.length > 2) {
        var user = createUser(parsed);
        if (user != null) {
          users.push(user);
          setResponseHeaders(response);
          response.end([users.length - 1].id + 1);//users[users.length - 1].id + 1
        }
        else {
          response.statusCode = 401;
          response.end();
        }
      }

    });
    response.end();
  }

  response.end();
});

if (module.parent) {
  module.exports = server
} else {
  server.listen(20007); }

/*function createUser(role) {
 var user = {};
 user.id = (users.length + 1).toString();
 user.name = role.name;
 user.phone = role.phone;
 if (role.role) {
 if (role.role === 'Administrator' || role.role === 'Support' || role.role) {
 user.role = role.role;
 }
 else {
 return null;
 }
 }
 else {
 user.role = 'Student';
 }
 return user;
 }*/

/*if(request.method === "OPTIONS") {
 response.writeHead(200, {
 'Access-Control-Allow-Methods': 'GET,HEAD,PUT,POST,DELETE',
 'Access-Control-Allow-Origin': '*',
 'Access-Control-Allow-Headers': 'Content-Type',
 'Content-Type': 'application/json; charset=utf-8'
 });
 response.end();
 } else if(request.method === "GET") {
 response.writeHead(200, {
 'Access-Control-Allow-Methods': 'GET,HEAD,PUT,POST,DELETE, OPTIONS',
 'Access-Control-Allow-Origin': '*',
 'Access-Control-Allow-Headers': 'Content-Type',
 'Content-Type': 'application/json; charset=utf-8'
 });
 response.end(JSON.stringify(users));
 }*/
